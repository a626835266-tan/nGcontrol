<%+header%>

<%
  require("uci")
  local huaweiLib = require("huaweiLib")
  local netm = require("luci.model.network").init() -- to get the interfaces' uptime

  x = uci.cursor()

  -- get list of enabled interfaces
  local interfaceEnabled = {}
  for i=1,6 do
    interfaceEnabled[i] = (x:get("mwan3", "UMTS"..i, "enabled") == "1")
  end


  local gateways = huaweiLib.getDefaultGateways()

  -- we only read info of ifaces we can reach and which are enabled
  local UMTS = {}
  for i=1,6 do
    local IP="192.168."..i..".1"
    if interfaceEnabled[i] and gateways[IP] then

      UMTS[i] = huaweiLib.queryStatus(IP)


-- add the two interface entries 'uptime' and 'retryAttempt'

      local net = netm:get_network("UMTS"..i)
      local time = tonumber(net:uptime())
      local days = math.floor(time/86400)
      local hrs  = math.floor(time/3600)
      local mins = math.floor(time/60 - (hrs*60))
      local secs = time%60

      if days == 0 then      
        UMTS[i].uptime = hrs.."h "..mins.."m "..secs.."s"
      else   
        UMTS[i].uptime = days.."d "..hrs.."h "..mins.."m "..secs.."s"
      end


      UMTS[i].retryAttempt = tostring(x:get("mwan3", "UMTS"..i, "retryAttempt"))

    end
  end

  local retryMax = tostring(x:get("mwan3", "config", "retryMax"))
  if retryMax == "-1" then retryMax = "&infin;" end
%>





<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">//<![CDATA[
  var stxhr = new XHR();
  function execute_action(action, iface)
  {
   var output = document.getElementById('processing' + action + iface);

   output.innerHTML = '<img src="<%=resource%>/icons/loading.gif" alt="..." style="width: 17px; padding: 0; vertical-align: middle;" /> ' + action + '...'; 

		output.parentNode.style.display = 'block';
		output.style.display = 'inline';


    stxhr.get('<%=luci.dispatcher.build_url("admin", "internetAccess", "statusChange")%>' + '/' + action + '/' + iface, null,
      function(x)
      {
        location.reload(true)
      }
    );
  }
//]]></script>


<h3>UMTS Interface Overview and Control Panel</h3>
<br> 

<style>

  tr.firstline td { padding-bottom: 0; border-bottom: 0}
  tr.lastline td  { padding-top: 0; border-top: 0;}
  tr.inner td { padding-top: 1px; padding-bottom: 1px; border: 0; }

  td[rowspan="4"] { vertical-align: middle; padding-top: 0; padding-bottom: 0;}
</style>


<table style="width:100%">

<%
  for i=1,6 do

    if interfaceEnabled[i] then

      -- enabled but not present (cannot reach UMTS stick)
      if not gateways["192.168."..i..".1"] then
%>
        <tr>
          <td><b>UMTS<%=tostring(i)%></b></td>
          <td colspan="6"><b><font color="red">Error:</font></b> Interface is enabled but there exists no route to. Check interface connection and router's routing table.</td>
          <td><input type="button" value="<%:Restart%>" class="cbi-button cbi-button-reload" onclick="execute_action('Restarting', '<%=i%>')" /></td>
        </tr>
<%
      else -- enabled and can reach

        -- get approx up/download in MB, .total*load is in byte, so devide by
        -- (1024*1024)=(10485.76*100) but also apply some rounding to 2 digital places.
        local upload = tostring( math.floor(tonumber(UMTS[i].totalUpload)/10485.76)/100).." MB"
        local download = tostring( math.floor(tonumber(UMTS[i].totalDownload)/10485.76)/100).." MB"
%>
         <tr class="firstline">
          <td><b>UMTS<%=tostring(i)%></b></td>
          <td colspan="2"><b><%
            if UMTS[i].connectionStatNum == '901' then
              luci.http.write("<font color='green'>Connected</font>")
            else
              luci.http.write("<font color='red'>"..UMTS[i].connectionStat.."</font>")
            end
            %></b></td>
          <td><b>Signal</b></td>
          <td><%=UMTS[i].strength%>/5</td>
          <td><b>Upload</b></td>
          <td><%=upload%></td>
            <td rowspan="4">
              <input type="button" value="<%:Disable%>" class="cbi-button cbi-button-reset" onclick="execute_action('Disabling', '<%=i%>')" /><br>
                <div style="line-height:50%;"><br></div>
              <input type="button" value="<%:Restart%>" class="cbi-button cbi-button-reload" onclick="execute_action('Restarting', '<%=i%>')" />
            </td>
        </tr>
        <tr class="inner">
          <td></td>
          <td><b>Provider</b></td>
          <td><%=UMTS[i].providerName%></td>
          <td><b>RSSI</b></td>
          <td><%=UMTS[i].rssi%></td>
          <td><b>Download</b></td>
          <td><%=download%></td>
          <td></td>
        </tr>
        <tr class="inner">
          <td></td>
          <td><b>Network</b></td>
          <td><%=UMTS[i].networkType%></td>
          <td><b>Cell ID</b></td>
          <td><%=UMTS[i].cellID%></td>
          <td><b>Resets</b></td>
          <td><%=UMTS[i].retryAttempt.."/"..retryMax%></td>
          <td></td>
        </tr>
        <tr class="lastline">
          <td></td>
          <td><b>Uptime</b></td>
          <td><%=UMTS[i].uptime%></td>
          <td><b>WAN IP</b></td>
          <td><%=UMTS[i].wanIPAddress%></td>
          <td></td>
          <td></td>
        </tr>
<%
      end

    else -- i.e. device is not enabled
%>
      <tr>
        <td><b>UMTS<%=tostring(i)%></b></td>
        <td colspan="6">Disabled</td>
        <td><input type="button" value="<%:Enable%>" class="cbi-button cbi-button-apply" onclick="execute_action('Enabling', '<%=i%>')" /></td>
      </tr>
<%
    end

  end --for all UMTS interfaces
%>
  <tr><td colspan="8"></td></tr> <!-- to make the footer-line in the last line -->

</table>

<br>


<%
  for i=1,6 do
%>


<fieldset class="cbi-section">
		<legend></legend>
		<div id="processingRestarting<%=i%>">


        <input type="button" value="<%:Enable%>" class="cbi-button cbi-button-apply" onclick="execute_action('Enabling', '<%=i%>')" />

</div>
</fieldset>

   <legend></legend>
                <div id="processingEnabling<%=i%>"></div>
</fieldset>



   <legend></legend>
                <div id="processingDisabling<%=i%>"></div>
</fieldset>


<%
end
%>
<%+footer%>
